<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AT-Limer">
    <meta name="theme-color" content="#000000">
    
    <title>AT-Limer</title>
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .title {
            font-size: 30px;
            font-weight: bold;
            color: #7CFC00;
        }

        .close-btn {
            font-size: 26px;
            color: #ff3b30;
            cursor: pointer;
            padding: 8px;
            display: none;
        }

        .close-btn.visible {
            display: block;
        }

        .status {
            color: #888;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            background: #007AFF;
            color: #fff;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn.scan {
            background: #007AFF;
        }

        .btn.danger {
            background: #ff3b30;
        }

        .device-list {
            margin-top: 16px;
        }

        .device-item {
            padding: 12px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            color: #fff;
        }

        .device-item:active {
            background: #1c1c1e;
        }

        .dashboard {
            display: none;
        }

        .dashboard.visible {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #7CFC00;
            margin: 24px 0 12px 0;
        }

        .hidden {
            display: none;
        }

        .scan-section {
            display: block;
        }

        .scan-section.hidden {
            display: none;
        }

        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1c1c1e;
            padding: 16px;
            border-top: 1px solid #333;
            display: none;
        }

        .install-prompt.visible {
            display: block;
        }

        .install-text {
            margin-bottom: 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="title">AT-Limer</div>
            <div class="close-btn" id="closeBtn" onclick="disconnect()">‚úï</div>
        </div>

        <div class="status" id="status">Idle</div>

        <!-- Scan Section -->
        <div class="scan-section" id="scanSection">
            <button class="btn scan" onclick="startScan()">üîç Scan</button>
            <div class="device-list" id="deviceList"></div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- Lock/Unlock -->
            <button class="btn" id="lockBtn" onclick="toggleLock()">üîí LOCKED</button>

            <!-- Light -->
            <button class="btn" id="lightBtn" onclick="toggleLight()">üí° LIGHT OFF</button>

            <!-- Speed Modes -->
            <div class="section-title">Speed Modes</div>
            <button class="btn" onclick="setSpeed('eco')">ECO</button>
            <button class="btn" onclick="setSpeed('normal')">NORMAL</button>
            <button class="btn" onclick="setSpeed('sport')">SPORT</button>
            <button class="btn danger" onclick="setSpeed('unlock')">‚ö†Ô∏è SPEED UNLOCK</button>
        </div>
    </div>

    <!-- Install Prompt (iOS Safari) -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-text">
            üì± Telep√≠tsd ezt az appot: Safari men√º ‚Üí "Add to Home Screen"
        </div>
        <button class="btn" onclick="closeInstallPrompt()">√ârtem</button>
    </div>

    <script>
        // State
        let device = null;
        let characteristic = null;
        let locked = true;
        let lightOn = false;
        let heartbeatTimer = null;

        const SERVICE_UUID = 0xFFE0;
        const CHAR_UUID = 0xFFE1;

        // Update status
        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        // Hex to ArrayBuffer
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }

        // Send hex command
        async function sendHex(hex) {
            if (!characteristic) return;
            try {
                const data = hexToBytes(hex);
                await characteristic.writeValue(data);
                console.log('Sent:', hex);
            } catch (err) {
                console.error('Write error:', err);
            }
        }

        // Start heartbeat
        function startHeartbeat() {
            stopHeartbeat();
            heartbeatTimer = setInterval(() => {
                sendHex('4643110100084C494D4542494B45BE8A');
            }, 500);
            console.log('Heartbeat started');
        }

        // Stop heartbeat
        function stopHeartbeat() {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
                console.log('Heartbeat stopped');
            }
        }

        // Scan for devices
        async function startScan() {
            try {
                setStatus('Scanning...');
                
                // Request device
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'AT-09' },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: [SERVICE_UUID]
                });

                setStatus('Connecting to ' + device.name);
                await connectDevice();

            } catch (err) {
                console.error('Scan error:', err);
                setStatus('Scan cancelled or failed');
            }
        }

        // Connect to device
        async function connectDevice() {
            try {
                const server = await device.gatt.connect();
                setStatus('Discovering services...');

                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);

                setStatus('Connected ‚úî');
                showDashboard();
                startHeartbeat();

            } catch (err) {
                console.error('Connection error:', err);
                setStatus('Connection failed');
            }
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('scanSection').classList.add('hidden');
            document.getElementById('dashboard').classList.add('visible');
            document.getElementById('closeBtn').classList.add('visible');
        }

        // Hide dashboard
        function hideDashboard() {
            document.getElementById('scanSection').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('visible');
            document.getElementById('closeBtn').classList.remove('visible');
        }

        // Disconnect
        async function disconnect() {
            stopHeartbeat();
            if (device && device.gatt.connected) {
                await device.gatt.disconnect();
            }
            device = null;
            characteristic = null;
            setStatus('Disconnected');
            hideDashboard();
        }

        // Toggle lock
        function toggleLock() {
            locked = !locked;
            const btn = document.getElementById('lockBtn');
            
            if (locked) {
                btn.textContent = 'üîí LOCKED';
                sendHex('464316610001F0E2AE');
                sendHex('464316120001F03B07');
            } else {
                btn.textContent = 'üîì UNLOCKED';
                sendHex('464316610001F1F28F');
                sendHex('464316120001F12B26');
            }
        }

        // Toggle light
        function toggleLight() {
            lightOn = !lightOn;
            const btn = document.getElementById('lightBtn');
            
            if (lightOn) {
                btn.textContent = 'üí° LIGHT ON';
                sendHex('464316120001F12B26');
            } else {
                btn.textContent = 'üí° LIGHT OFF';
                sendHex('464316120001F03B07');
            }
        }

        // Set speed mode
        function setSpeed(mode) {
            switch(mode) {
                case 'eco':
                    sendHex('464316110002EE0677');
                    break;
                case 'normal':
                    sendHex('464316110002DC1066');
                    break;
                case 'sport':
                    sendHex('464316110002023AD5');
                    break;
                case 'unlock':
                    sendHex('46431611000200FF3A8B');
                    break;
            }
        }

        // Install prompt for iOS
        function showInstallPrompt() {
            // Check if standalone (already installed)
            const isStandalone = window.navigator.standalone || 
                                window.matchMedia('(display-mode: standalone)').matches;
            
            // Check if iOS Safari
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (!isStandalone && isIOS) {
                document.getElementById('installPrompt').classList.add('visible');
            }
        }

        function closeInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('visible');
            localStorage.setItem('installPromptClosed', 'true');
        }

        // Check Web Bluetooth support
        if (!navigator.bluetooth) {
            setStatus('‚ö†Ô∏è Web Bluetooth not supported. Use Chrome or Edge on Android, or Bluefy on iOS.');
        }

        // Show install prompt after 3 seconds
        if (!localStorage.getItem('installPromptClosed')) {
            setTimeout(showInstallPrompt, 3000);
        }

        // Handle disconnect
        if (device) {
            device.addEventListener('gattserverdisconnected', () => {
                setStatus('Device disconnected');
                disconnect();
            });
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => {
                console.log('Service Worker registered');
            });
        }
    </script>
</body>
</html>
